<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>EU7 Light-Duty Report</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: "Inter", "Segoe UI", sans-serif; margin: 0; padding: 2.5rem; background: #f8fafc; color: #0f172a; }
      h1, h2, h3 { margin: 0; }
      h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
      h2 { font-size: 1.4rem; margin-top: 2rem; margin-bottom: 0.75rem; }
      h3 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; }
      p { margin: 0.25rem 0; }
      table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 0.92rem; }
      th, td { border: 1px solid #cbd5f5; padding: 0.45rem 0.6rem; text-align: left; }
      th { background: #e2e8f0; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.08em; }
      tbody tr:nth-child(even) { background: #f1f5f9; }
      .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; }
      .badge-pass { background: #d1fae5; color: #047857; }
      .badge-fail { background: #fee2e2; color: #b91c1c; }
      .badge-pending { background: #fef3c7; color: #b45309; }
      .meta { margin-top: 0.25rem; font-size: 0.9rem; color: #475569; }
      .section { page-break-inside: avoid; }
    </style>
  </head>
  <body>
    {% set payload = results_payload or {} %}
    {% set sections = payload.sections or [] %}
    {% set final_block = payload.final %}
    {% set meta = payload.meta or {} %}
    {% set final_status = final_block.pass if final_block else None %}

    <header>
      <h1>EU7 Light-Duty Compliance Report</h1>
      {% if meta.legislation %}
      <p class="meta">Legislation: {{ meta.legislation }}</p>
      {% endif %}
      {% if meta.version %}
      <p class="meta">Specification version: {{ meta.version }}</p>
      {% endif %}
      <p class="meta">
        Overall result:
        {% if final_block is none %}
        <span class="badge badge-pending">Pending</span>
        {% elif final_status %}
        <span class="badge badge-pass">Pass</span>
        {% else %}
        <span class="badge badge-fail">Fail</span>
        {% endif %}
      </p>
    </header>

    {% for section in sections %}
    {% set criteria = section.criteria or [] %}
    <div class="section">
      <h2>{{ section.title }}</h2>
      {% if criteria %}
      <table>
        <thead>
          <tr>
            <th>Ref</th>
            <th>Criterion</th>
            <th>Condition</th>
            <th>Value</th>
            <th>Unit</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {% for row in criteria %}
          <tr>
            <td>{{ row.ref }}</td>
            <td>{{ row.criterion }}</td>
            <td>{{ row.condition }}</td>
            <td>{{ row.value }}</td>
            <td>{{ row.unit }}</td>
            <td>
              {% if row.pass %}
              <span class="badge badge-pass">Pass</span>
              {% else %}
              <span class="badge badge-fail">Fail</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No criteria available.</p>
      {% endif %}
    </div>
    {% endfor %}

    <div class="section">
      <h2>Final Conformity</h2>
      {% if final_block and final_block.pollutants %}
      <table>
        <thead>
          <tr>
            <th>Pollutant</th>
            <th>Condition</th>
            <th>Value</th>
            <th>Unit</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {% for pollutant in final_block.pollutants %}
          <tr>
            <td>{{ pollutant.criterion }}</td>
            <td>{{ pollutant.condition }}</td>
            <td>{{ pollutant.value }}</td>
            <td>{{ pollutant.unit }}</td>
            <td>
              {% if pollutant.pass %}
              <span class="badge badge-pass">Pass</span>
              {% else %}
              <span class="badge badge-fail">Fail</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>Emission limits not fully configured; final verdict pending.</p>
      {% endif %}
    </div>
  </body>
</html>
