<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EU7 Light-Duty Compliance</title>
    <link rel="stylesheet" href="/static/leaflet/leaflet.css" />
    <link rel="stylesheet" href="/static/css/styles.css" />
    <link rel="stylesheet" href="/static/css/app.css" />
  </head>
  {% set payload = results_payload or {} %}
  {% set meta = payload.meta or {} %}
  {% set final_block = payload.final or {} %}
  {% set final_pass = overall_pass if overall_pass is not none else final_block.pass %}
  {% set status_class = 'pass' if final_pass is sameas true else ('fail' if final_pass is sameas false else 'pending') %}
  <body class="rde dark-theme">
    <header class="rde-header sticky">
      <div class="lhs">
        <h1>EU7 Light-Duty Compliance</h1>
        <div class="meta">
          <span class="pill">EU7 LD / UN R168 MAW</span>
          <span class="pill">{{ meta.testId or report.meta.testId }}</span>
          <span class="pill">{{ meta.velocitySource or report.meta.velocitySource }}</span>
        </div>
      </div>
      <div class="rhs">
        <span class="overall badge {{ 'pass' if final_pass else 'fail' if final_pass is not none else 'pending' }}">
          Overall: {{ 'PASS' if final_pass is sameas true else ('FAIL' if final_pass is sameas false else 'PENDING') }}
        </span>
        <div class="actions">
          <button id="run-analysis">Run</button>
          <div class="split">
            <button id="download-pdf">PDF</button>
            <button id="download-json">JSON</button>
          </div>
        </div>
      </div>
    </header>

    <section class="kpis" id="kpis"></section>

    <div class="grid">
      <main>
        {% include 'partials/section_precon_soak.html' %}
        {% include 'partials/section_cold_start.html' %}
        {% include 'partials/section_trip_shares.html' %}
        {% include 'partials/section_elevation.html' %}
        {% include 'partials/section_gps.html' %}
        {% include 'partials/section_span_zero.html' %}
        {% include 'partials/section_devices.html' %}
        {% include 'partials/section_dynamics.html' %}
        {% include 'partials/section_maw_coverage.html' %}
        {% include 'partials/section_emissions_summary.html' %}
        {% include 'partials/section_final_conformity.html' %}
      </main>
      <aside>
        <div class="panel tabs" id="viz">
          <nav>
            <button data-tab="overview" class="active">Overview</button>
            <button data-tab="emissions">Emissions</button>
            <button data-tab="dynamics">Dynamics</button>
            <button data-tab="maw">MAW</button>
            <button data-tab="map">Map</button>
            <button data-tab="ambient">Ambient/QA</button>
          </nav>
          <div class="tab-content">
            <canvas id="chart-overview"></canvas>
            <canvas id="chart-emissions" hidden></canvas>
            <canvas id="chart-dynamics" hidden></canvas>
            <canvas id="chart-maw" hidden></canvas>
            <div id="map" hidden></div>
            <canvas id="chart-ambient" hidden></canvas>
            <div id="qa-regressions" hidden>
              <canvas id="chart-efm"></canvas>
              <canvas id="chart-fuel"></canvas>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <script src="/static/leaflet/leaflet.js"></script>
    <script>
      window.results_payload = {{ results_payload_json | safe }};
      window.__EU7_REPORT__ = window.results_payload;
      window.__RDE_RESULT__ = window.results_payload;
      document.dispatchEvent(new Event('rde:payload-ready'));
    </script>
    <script src="/static/js/app.js"></script>
  </body>
</html>
