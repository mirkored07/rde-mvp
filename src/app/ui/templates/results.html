{% set payload = results_payload or {} %}
{% set sections = payload.sections or [] %}
{% set final_block = payload.final %}
{% set meta = payload.meta or {} %}
{% set final_status = final_block.pass if final_block else None %}

<section class="mx-auto flex w-full max-w-5xl flex-col gap-8 px-4 py-10">
  <header class="flex flex-col gap-4 border-b border-slate-200 pb-6 dark:border-slate-700">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-baseline sm:gap-4">
        <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">
          EU7 Light-Duty Compliance Report
          {% if meta.legislation %}
          <span class="ml-2 text-xs px-2 py-0.5 rounded bg-sky-600/20 text-sky-300">
            {{ meta.legislation }}
          </span>
          {% endif %}
        </h1>
        <div class="flex items-center gap-2 text-sm">
          <span class="font-semibold text-slate-500 dark:text-slate-300">Overall result:</span>
          {% if final_block is none %}
          <span class="rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-700 dark:bg-amber-500/20 dark:text-amber-200">Pending limits</span>
          {% elif final_status %}
          <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Pass</span>
          {% else %}
          <span class="rounded-full bg-rose-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-rose-700 dark:bg-rose-500/20 dark:text-rose-200">Fail</span>
          {% endif %}
        </div>
      </div>
      <button
        id="btn-export-pdf"
        type="button"
        class="btn btn-primary inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-sky-500 via-blue-600 to-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-sky-500/30 transition hover:shadow-sky-600/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-sky-500"
      >
        Download PDF
      </button>
    </div>
    <p class="max-w-3xl text-sm text-slate-500 dark:text-slate-400">
      Automated evaluation of the EU7 Light-Duty Real Driving Emissions (RDE) criteria covering zero/span checks, trip composition, dynamics, GPS validity, and pollutant-specific emission limits.
    </p>
  </header>

  <section class="rounded-xl border border-slate-700/50 bg-slate-900/40 p-4">
    <div class="flex items-center justify-between">
      <h2 class="text-slate-100 text-sm font-semibold">EU7 Quick Verdict</h2>
      {% if final_block is not none and final_block.pass is not none %}
        {% set ok = final_block.pass %}
        <span class="px-2 py-0.5 rounded text-xs {{ 'bg-emerald-600/20 text-emerald-300' if ok else 'bg-rose-600/20 text-rose-300' }}">
          {{ 'PASS' if ok else 'FAIL' }}
        </span>
      {% endif %}
    </div>
    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
      {% for block in sections %}
        {% if block.title in ['Pre/Post Checks (Zero/Span)','Trip Composition & Timing','Dynamics & MAW','GPS Validity','Emissions Summary'] %}
          {% set quick_criteria = (block.criteria or [])[:2] %}
          {% for r in quick_criteria %}
            <div class="flex items-center justify-between rounded border border-slate-800/60 bg-slate-800/30 px-2 py-1">
              <span class="text-slate-300 truncate" title="{{ r.criterion }}">{{ r.criterion }}</span>
              <span class="ml-2 px-2 py-0.5 rounded {{ 'bg-emerald-600/20 text-emerald-300' if r.pass else 'bg-rose-600/20 text-rose-300' }}">{{ 'Pass' if r.pass else 'Fail' }}</span>
            </div>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>
  </section>

  <div class="rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
    <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Summary</h2>
    <div id="analysis-summary-content" class="prose prose-sm mt-3 max-w-none prose-slate dark:prose-invert"></div>
  </div>

  <section class="grid gap-6">
    {% for section in sections %}
    {% set criteria = section.criteria or [] %}
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">{{ section.title }}</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Criterion overview</span>
      </div>
      {% if criteria %}
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-sm dark:divide-slate-700">
          <thead class="bg-slate-100 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:bg-slate-800/80 dark:text-slate-300">
            <tr>
              <th scope="col" class="px-4 py-3 text-left">Ref</th>
              <th scope="col" class="px-4 py-3 text-left">Criterion</th>
              <th scope="col" class="px-4 py-3 text-left">Condition</th>
              <th scope="col" class="px-4 py-3 text-left">Value</th>
              <th scope="col" class="px-4 py-3 text-left">Unit</th>
              <th scope="col" class="px-4 py-3 text-left">Result</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
            {% for row in criteria %}
            {% set row_pass = row.pass %}
            <tr class="bg-white/60 text-slate-700 dark:bg-slate-900/60 dark:text-slate-200">
              <td class="px-4 py-3 font-semibold text-slate-500 dark:text-slate-400">{{ row.ref }}</td>
              <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">{{ row.criterion }}</td>
              <td class="px-4 py-3 text-slate-600 dark:text-slate-300">{{ row.condition }}</td>
              <td class="px-4 py-3">{{ row.value }}</td>
              <td class="px-4 py-3">{{ row.unit }}</td>
              <td class="px-4 py-3">
                {% if row_pass %}
                <span class="inline-flex rounded-full bg-emerald-500/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Pass</span>
                {% else %}
                <span class="inline-flex rounded-full bg-rose-500/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-rose-700 dark:bg-rose-500/20 dark:text-rose-200">Fail</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">No criteria available for this section.</p>
      {% endif %}
    </article>
    {% endfor %}
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Final Conformity</h3>
    {% if final_block and final_block.pollutants %}
    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Overall result computed from the emissions criteria.</p>
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm dark:divide-slate-700">
        <thead class="bg-slate-100 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:bg-slate-800/80 dark:text-slate-300">
          <tr>
            <th scope="col" class="px-4 py-3 text-left">Pollutant</th>
            <th scope="col" class="px-4 py-3 text-left">Condition</th>
            <th scope="col" class="px-4 py-3 text-left">Value</th>
            <th scope="col" class="px-4 py-3 text-left">Unit</th>
            <th scope="col" class="px-4 py-3 text-left">Result</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
          {% for pollutant in final_block.pollutants %}
          <tr class="bg-white/60 text-slate-700 dark:bg-slate-900/60 dark:text-slate-200">
            <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">{{ pollutant.criterion }}</td>
            <td class="px-4 py-3 text-slate-600 dark:text-slate-300">{{ pollutant.condition }}</td>
            <td class="px-4 py-3">{{ pollutant.value }}</td>
            <td class="px-4 py-3">{{ pollutant.unit }}</td>
            <td class="px-4 py-3">
              {% if pollutant.pass %}
              <span class="inline-flex rounded-full bg-emerald-500/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-200">Pass</span>
              {% else %}
              <span class="inline-flex rounded-full bg-rose-500/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-rose-700 dark:bg-rose-500/20 dark:text-rose-200">Fail</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Emission limits not fully configured; final verdict pending.</p>
    {% endif %}
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Charts &amp; KPIs</h3>
      <div class="mt-4" id="charts-kpis">
        <div id="chart-speed" class="w-full" style="height: 320px; width: 100%;"></div>
      </div>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Route map</h3>
      <div id="drive-map" class="mt-4 h-80 w-full rounded-xl border border-slate-200 bg-slate-100 dark:border-slate-700 dark:bg-slate-800"></div>
    </div>
  </section>
</section>

<script>
  // Inject the EU7 payload for the UI and tests
  window.__RDE_RESULT__ = {{ results_payload | tojson | safe }};
  // Fire the ready event. Tests depend on this.
  window.dispatchEvent(new Event('rde:payload-ready'));
  document.dispatchEvent(new Event('rde:payload-ready'));
</script>
<!-- App bundle must come after payload -->
<script src="/static/js/app.js"></script>
