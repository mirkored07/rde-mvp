{% set payload = results_payload or {} %}
{% set meta = payload.meta or {} %}
{% set final_block = payload.final or {} %}
{% set final_status = final_block.pass if final_block else None %}
{% set payload_json = results_payload_json if results_payload_json is not none else (results_payload | tojson) %}

<!-- Leaflet assets for interactive map -->
<link rel="stylesheet" href="/static/leaflet/leaflet.css">
<script src="/static/leaflet/leaflet.js"></script>

<section class="mx-auto flex w-full max-w-5xl flex-col gap-8 px-4 py-10">
  <header class="flex flex-col gap-4 border-b border-slate-200 pb-6 dark:border-slate-700">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-baseline sm:gap-4">
        <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">
          EU7 Light-Duty Compliance Report
          <span id="legislation-badge" class="ml-2 text-xs px-2 py-0.5 rounded bg-sky-600/20 text-sky-300">
            {{ meta.legislation or "EU7 Light-Duty" }}
          </span>
        </h1>
        <div class="flex items-center gap-2 text-sm">
          <span class="font-semibold text-slate-500 dark:text-slate-300">Overall result:</span>
          <span
            id="overall-result-badge"
            class="rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide {{ 'bg-emerald-500/20 text-emerald-200' if final_status else 'bg-amber-500/20 text-amber-700 dark:text-amber-200' }}"
          >
            {% if final_status is none %}Pending limits{% elif final_status %}Pass{% else %}Fail{% endif %}
          </span>
        </div>
      </div>
      <button
        id="btn-export-pdf"
        type="button"
        class="btn btn-primary inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-sky-500 via-blue-600 to-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-sky-500/30 transition hover:shadow-sky-600/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-sky-500"
      >
        Download PDF
      </button>
    </div>
    <p class="max-w-3xl text-sm text-slate-500 dark:text-slate-400">
      Automated evaluation of the EU7 Light-Duty Real Driving Emissions (RDE) criteria covering zero/span checks, trip composition, dynamics, GPS validity, and pollutant-specific emission limits.
    </p>
  </header>

  <section class="rounded-xl border border-slate-700/50 bg-slate-900/40 p-4">
    <div class="flex items-center justify-between">
      <h2 class="text-slate-100 text-sm font-semibold">EU7 Quick Verdict</h2>
      <span id="quick-verdict-summary" class="px-2 py-0.5 rounded text-xs bg-slate-800/40 text-slate-300">Summary pending</span>
    </div>
    <div id="quick-verdicts" class="mt-2 grid grid-cols-1 gap-2 text-xs sm:grid-cols-2 lg:grid-cols-3">
      <div class="rounded border border-slate-800/60 bg-slate-800/30 px-2 py-2 text-slate-400">Loading quick verdicts…</div>
    </div>
  </section>

  <div class="rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
    <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Summary</h2>
    <div id="analysis-summary-content" class="prose prose-sm mt-3 max-w-none prose-slate dark:prose-invert">
      <p class="text-slate-500 dark:text-slate-400">Summary will render once results are ready.</p>
    </div>
  </div>

  <section class="grid gap-6">
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Pre/Post Checks (Zero/Span)</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Criterion overview</span>
      </div>
      <div id="section-zero-span" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Loading criteria…</div>
    </article>
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Trip Composition &amp; Timing</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Criterion overview</span>
      </div>
      <div id="section-trip-comp" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Loading criteria…</div>
    </article>
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Dynamics &amp; MAW</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Criterion overview</span>
      </div>
      <div id="section-dynamics" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Loading criteria…</div>
    </article>
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">GPS Validity</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Criterion overview</span>
      </div>
      <div id="section-gps" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Loading criteria…</div>
    </article>
    <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <div class="flex items-center justify-between gap-4">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Emissions Summary</h3>
        <span class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">Pollutant overview</span>
      </div>
      <div id="section-emissions" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Emission metrics loading…</div>
    </article>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Final Conformity</h3>
    <div id="section-final" class="mt-4 text-sm text-slate-500 dark:text-slate-400">Final conformity criteria pending…</div>
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Charts &amp; KPIs</h3>
      <div class="mt-4" id="charts-kpis">
        <div id="chart-speed" class="w-full" style="height: 320px; width: 100%;"></div>
      </div>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
      <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-300">Route map</h3>
      <div id="drive-map" class="mt-4 h-80 w-full rounded-xl border border-slate-200 bg-slate-100 dark:border-slate-700 dark:bg-slate-800"></div>
    </div>
  </section>
</section>

<!-- Inject payload first -->
<script>
  window.results_payload = {{ payload_json | safe }};
  window.__RDE_RESULT__ = window.results_payload;
  document.dispatchEvent(new Event("rde:payload-ready"));
</script>

<!-- Then load the bundle -->
<script src="{{ url_for('static', path='js/app.js') }}"></script>

<!-- (If you use HTMX, keep afterSwap trigger as well) -->
<script>
  document.addEventListener("htmx:afterSwap", function() {
    document.dispatchEvent(new Event("rde:payload-ready"));
  });
</script>
