<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ title or 'EU7 Light-Duty Report' }}</title>
    <style>
      body { font-family: "Helvetica", "Arial", sans-serif; margin: 24px; color: #1f2937; }
      h1, h2, h3 { color: #111827; margin-bottom: 0.2rem; }
      h1 { font-size: 26px; text-transform: uppercase; letter-spacing: 0.3em; }
      h2 { font-size: 20px; border-bottom: 2px solid #0f172a; padding-bottom: 0.25rem; }
      h3 { font-size: 16px; margin-top: 1.8rem; }
      p { margin: 0.2rem 0; }
      .meta { font-size: 12px; color: #4b5563; margin-bottom: 1rem; }
      .summary { border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; background: #f9fafb; margin-bottom: 1.5rem; }
      .summary strong { font-size: 18px; }
      .badge { display: inline-block; padding: 4px 10px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
      .badge.pass { background: #d1fae5; color: #047857; }
      .badge.fail { background: #fee2e2; color: #b91c1c; }
      table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 12px; }
      th, td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: left; vertical-align: top; }
      th { background: #f3f4f6; text-transform: uppercase; letter-spacing: 0.2em; font-size: 11px; }
      tbody tr:nth-child(odd) { background: #f9fafb; }
      .notes { margin-top: 0.5rem; font-size: 11px; color: #6b7280; }
    </style>
  </head>
  <body>
    <header>
      <h1>{{ heading or 'EU7 Light-Duty' }}</h1>
      <div class="meta">
        <p>Legislation: {{ results_payload.meta.legislation if results_payload.meta else 'EU7 Light-Duty' }}</p>
        <p>Generated: {{ generated_at }}</p>
      </div>
    </header>

    {% set final_block = results_payload.final if results_payload.final is mapping else {} %}
    <section class="summary">
      <p><strong>Overall conformity:</strong> {{ 'PASS' if final_block.get('pass') else 'FAIL' }}</p>
      <p>Status:
        <span class="badge {{ 'pass' if final_block.get('pass') else 'fail' }}">{{ 'PASS' if final_block.get('pass') else 'FAIL' }}</span>
      </p>
      {% if final_block.get('notes') %}
      <div class="notes">
        <p><strong>Notes:</strong></p>
        <ul>
          {% for note in final_block.get('notes') %}
          <li>{{ note }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </section>

    {% set sections = results_payload.sections if results_payload.sections else [] %}
    {% for section in sections %}
    {% set criteria = section.get('criteria') if section is mapping else [] %}
    <section>
      <h2>{{ section.get('title') or 'Section' }}</h2>
      {% if criteria %}
      <table>
        <thead>
          <tr>
            <th>Ref</th>
            <th>Criterion</th>
            <th>Condition</th>
            <th>Value</th>
            <th>Unit</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {% for row in criteria %}
          {% set row_map = row if row is mapping else {} %}
          <tr>
            <td>{{ row_map.get('ref') or '—' }}</td>
            <td>{{ row_map.get('criterion') or '—' }}</td>
            <td>{{ row_map.get('condition') or 'n/a' }}</td>
            <td>{{ row_map.get('value') if row_map.get('value') is not none else 'n/a' }}</td>
            <td>{{ row_map.get('unit') or '—' }}</td>
            <td>
              <span class="badge {{ 'pass' if row_map.get('pass') else 'fail' }}">{{ 'PASS' if row_map.get('pass') else 'FAIL' }}</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No criteria recorded.</p>
      {% endif %}
    </section>
    {% endfor %}
  </body>
</html>
